---
# yaml-language-server: $schema=https://github.com/instrumenta/kubernetes-json-schema/raw/refs/heads/master/v1.18.1/serviceaccount-v1.json
apiVersion: v1
kind: ServiceAccount
metadata:
  name: ceph-mgr-sync
---
# yaml-language-server: $schema=https://github.com/instrumenta/kubernetes-json-schema/raw/refs/heads/master/v1.18.1/role-rbac-v1.json
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: ceph-mgr-sync
rules:
  - apiGroups: ["helm.toolkit.fluxcd.io"]
    resources: ["helmreleases"]
    verbs: ["get","patch"]
---
# yaml-language-server: $schema=https://github.com/instrumenta/kubernetes-json-schema/raw/refs/heads/master/v1.18.1/rolebinding-rbac-v1.json
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: ceph-mgr-sync
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: ceph-mgr-sync
subjects:
  - kind: ServiceAccount
    name: ceph-mgr-sync
---
# yaml-language-server: $schema=https://github.com/instrumenta/kubernetes-json-schema/raw/refs/heads/master/v1.18.1/cronjob.json
apiVersion: batch/v1
kind: CronJob
metadata:
  name: ceph-mgr-endpoint-sync
spec:
  schedule: "*/5 * * * *"   # every 5 minutes
  concurrencyPolicy: Replace
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: ceph-mgr-sync
          containers:
            - name: sync-mgr-endpoint
              image: bitnami/kubectl:1.33.0-debian-12-r1
              securityContext:
                runAsUser: 0
              command: ["/bin/sh","-c"]
              args:
                - |
                  set -eu

                  # 1) Install only curl (tiny)
                  mkdir -p /var/lib/apt/lists/partial
                  apt-get update && apt-get install -y --no-install-recommends curl \
                    && rm -rf /var/lib/apt/lists/*

                  ACTIVE_IP=""

                  for IP in 10.10.10.1 10.10.10.2 10.10.10.3; do
                    echo "→ Testing $IP…" >&2

                    # 2a) Check HTTP status
                    STATUS=$(curl -s -o /dev/null -w "%{http_code}" "http://${IP}:9283/metrics" || echo "000")
                    echo "   HTTP status: $STATUS" >&2
                    [ "$STATUS" = "200" ] || continue

                    # 2b) Sniff for the mgr metric
                    SAMPLE=$(curl -s "http://${IP}:9283/metrics" | grep ceph_mgr_metadata | head -n1 || true)
                    echo "   Sample metric: ${SAMPLE:-<none>}" >&2

                    # 2c) Does it show state=\"active\"?
                    if echo "$SAMPLE" | grep -q 'state="active"'; then
                      echo "   ✅ Found active on $IP" >&2
                      ACTIVE_IP="$IP"
                      break
                    else
                      echo "   ⚠️  Not active, skipping" >&2
                    fi
                  done

                  if [ -z "$ACTIVE_IP" ]; then
                    echo "ERROR: no active MGR found" >&2
                    exit 1
                  fi

                  # 3) Patch in the one IP
                  echo "Patching HelmRelease to use $ACTIVE_IP" >&2
                  kubectl -n rook-ceph patch helmrelease rook-ceph-cluster \
                    --type=merge \
                    --patch "{\"spec\":{\"values\":{\"monitoring\":{\"externalMgrEndpoints\":[{\"ip\":\"${ACTIVE_IP}\"}]}}}}"
          restartPolicy: OnFailure